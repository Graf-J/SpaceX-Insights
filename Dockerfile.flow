# Install dependencies using uv 
FROM ghcr.io/astral-sh/uv:python3.13-bookworm AS builder

# Set work directory
WORKDIR /app

# Install minimal compiler for SOME pip deps (optional) 
RUN apt-get update && apt-get install -y build-essential cmake


# Copy dependency files
COPY pyproject.toml .
COPY uv.lock .

# Install dependencies into /.venv
RUN uv sync --frozen --no-dev


# Build runtime image
FROM python:3.13-slim AS runtime

WORKDIR /app


# Copy dependencies from builder
COPY --from=builder /app/.venv ./.venv

ENV PATH=".venv/bin:$PATH"


# Copy project code
COPY etl ./etl


# Prefect needs this

ENV PREFECT_API_URL=http://prefect-server:4200/api

CMD [".venv/bin/python", "-m", "etl.flows.etl_flow"]